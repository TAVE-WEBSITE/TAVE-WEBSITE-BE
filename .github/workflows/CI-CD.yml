name: Java CI/CD with Gradle

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  ì¡°ê±´ì„ ì •ì˜í•©ë‹ˆë‹¤.
on:
  push:
    branches: [ "main" ] # main ë¸Œëœì¹˜ì— pushê°€ ë°œìƒí•˜ë©´ ì‹¤í–‰ë©ë‹ˆë‹¤.

# ì›Œí¬í”Œë¡œìš°ê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.
permissions:
  contents: read

jobs:
  # Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  Docker Hubì— í‘¸ì‹œí•˜ëŠ” ì‘ì—…ì„ ì •ì˜í•©ë‹ˆë‹¤.
  build-docker-image:
    runs-on: ubuntu-latest # ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤.
    steps:
      # ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
      - uses: actions/checkout@v3

      # JDK 17ì„ ì„¤ì¹˜í•˜ê³  í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle Wrapper íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
      - name: Grant Execute Permission For Gradlew
        run: chmod +x gradlew

      # gradle caching - ë¹Œë“œ ì‹œê°„ í–¥ìƒ
      - name: Gradle Caching
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Gradleì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
      - name: Build With Gradle
        run: ./gradlew build -x test

      # Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
      - name: docker image build
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/github-actions-demo .

      # Docker Hubì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ ì •ë³´ëŠ” GitHub Secretsë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ê´€ë¦¬ë©ë‹ˆë‹¤.
      - name: docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # Docker Hub ì‚¬ìš©ì ì´ë¦„
          password: ${{ secrets.DOCKERHUB_PASSWORD }} # Docker Hub ë¹„ë°€ë²ˆí˜¸

      # ë¹Œë“œëœ Docker ì´ë¯¸ì§€ë¥¼ Docker Hubì— í‘¸ì‹œí•©ë‹ˆë‹¤.
      - name: docker Hub push
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/github-actions-demo

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          port: 22
          key: ${{ secrets.PROD_SSH_SECRET_PRIVATE_KEY }}
          script: |
            set -e

            echo "ğŸ“ [1] tave ë””ë ‰í† ë¦¬ë¡œ ì´ë™"
            cd ~/tave

            echo "ğŸ”„ [2] deploy.sh ì‹¤í–‰"
            ./deploy.sh